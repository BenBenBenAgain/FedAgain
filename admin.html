<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Fed Again ‚Äî Admin QR Generator</title>
    <style>
      :root { color-scheme: light; }
      body {
        margin: 0;
        font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
        background: #ffffff;
        color: #111;
      }
      .wrap {
        max-width: 720px;
        margin: 0 auto;
        padding: 28px 18px 40px;
      }

      h1 {
        font-size: 22px;
        margin: 0 0 14px;
        letter-spacing: -0.02em;
      }
      .sub {
        margin: 0 0 18px;
        color: #6b7280;
        font-size: 13px;
      }

      .card {
        border: 1px solid #e5e7eb;
        border-radius: 14px;
        padding: 14px;
        background: #fff;
        margin: 12px 0;
      }

      label {
        display: block;
        font-size: 12px;
        color: #6b7280;
        margin-bottom: 6px;
      }
      input {
        width: 100%;
        padding: 12px;
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        font-size: 14px;
        box-sizing: border-box;
        margin-bottom: 10px;
      }

      button {
        appearance: none;
        border: 1px solid #111;
        background: #fff;
        color: #111;
        border-radius: 12px;
        padding: 12px 12px;
        font-size: 14px;
        font-weight: 800;
        cursor: pointer;
      }
      button:disabled { opacity: 0.5; cursor: not-allowed; }

      .row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
        margin-top: 6px;
      }

      .err {
        margin-top: 10px;
        color: #b91c1c;
        font-size: 13px;
        display: none;
      }
      .ok {
        margin-top: 10px;
        color: #047857;
        font-size: 13px;
        display: none;
      }

      .out { display: none; }
      a { word-break: break-all; }

      /* Print layout */
      .printWrap {
        display: grid;
        place-items: center;
        padding: 10px 10px 6px;
      }
      .printTitle {
        font-size: 28px;
        font-weight: 800;
        text-align: center;
        letter-spacing: -0.02em;
        margin: 6px 0 18px;
      }
      .qrBox {
        border: 1px solid #e5e7eb;
        border-radius: 16px;
        padding: 14px;
        background: #fff;
        display: grid;
        place-items: center;
      }
      img {
        width: 320px;
        max-width: 100%;
        border-radius: 10px;
        background: #fff;
      }
      .printLabel {
        margin-top: 12px;
        font-weight: 800;
        text-align: center;
        font-size: 18px;
      }
      .brand {
        margin-top: 22px;
        text-align: center;
        letter-spacing: 0.22em;
        font-size: 11px;
        color: #9ca3af;
        font-weight: 800;
      }

      @media print {
        .no-print { display: none !important; }
        .wrap { max-width: none; padding: 0; }
        .card { border: none; margin: 0; padding: 0; }
        .qrBox { border: none; }
      }
    </style>
  </head>

  <body>
    <div class="wrap">
      <div class="no-print">
        <h1>Fed Again ‚Äî Admin QR Generator</h1>
        <p class="sub">Create a labelled household QR (includes both <code>h</code> and <code>k</code>).</p>

        <div class="card">
          <label for="label">Household label (prints under QR)</label>
          <input id="label" type="text" placeholder="e.g. Mum & Dad / Pawsha Fridge / House 07" />

          <label for="secret">Admin secret (not stored)</label>
          <input id="secret" type="password" placeholder="Enter x-admin-secret value" />

          <div class="row">
            <button id="createBtn" type="button">Create household + QR</button>
            <button id="clearBtn" type="button">Clear</button>
          </div>

          <div class="err" id="err"></div>
          <div class="ok" id="ok"></div>
        </div>
      </div>

      <div class="card out" id="out">
        <div class="no-print" style="margin-bottom:12px;">
          <label>Household URL</label>
          <a id="link" href="#" target="_blank" rel="noopener">‚Äî</a>

          <div class="row" style="margin-top:10px;">
            <button id="copyBtn" type="button">Copy URL</button>
            <button id="printBtn" type="button">Print QR</button>
          </div>
        </div>

        <div class="printWrap">
          <div class="printTitle">Has üê∂ been Fed? Walked?</div>

          <div class="qrBox">
            <img id="qrImg" alt="QR code" />
          </div>

          <div class="printLabel" id="printLabel"></div>

          <div class="brand">FED AGAIN</div>
        </div>
      </div>
    </div>

    <script>
      const $label = document.getElementById("label");
      const $secret = document.getElementById("secret");
      const $createBtn = document.getElementById("createBtn");
      const $clearBtn = document.getElementById("clearBtn");
      const $copyBtn = document.getElementById("copyBtn");
      const $printBtn = document.getElementById("printBtn");
      const $err = document.getElementById("err");
      const $ok = document.getElementById("ok");
      const $out = document.getElementById("out");
      const $link = document.getElementById("link");
      const $qrImg = document.getElementById("qrImg");
      const $printLabel = document.getElementById("printLabel");

      function showErr(msg) {
        $err.textContent = msg;
        $err.style.display = "block";
        $ok.style.display = "none";
      }
      function showOk(msg) {
        $ok.textContent = msg;
        $ok.style.display = "block";
        $err.style.display = "none";
      }
      function clearMsgs() {
        $err.textContent = "";
        $err.style.display = "none";
        $ok.textContent = "";
        $ok.style.display = "none";
      }

      async function createHousehold() {
        clearMsgs();
        $createBtn.disabled = true;

        try {
          const secret = $secret.value.trim();
          const label = $label.value.trim();

          if (!label) throw new Error("Enter a household label (so you don‚Äôt mix them up).");
          if (!secret) throw new Error("Enter the admin secret.");

          const resp = await fetch("/api/create-household", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "x-admin-secret": secret
            },
            body: JSON.stringify({ label })
          });

          const text = await resp.text();
          let json;
          try { json = JSON.parse(text); } catch { throw new Error(text); }

          if (!resp.ok) throw new Error(json?.error || "Request failed.");

          $link.href = json.url;
          $link.textContent = json.url;
          $qrImg.src = json.qrPngUrl;
          $printLabel.textContent = json.label || label;

          $out.style.display = "block";
          showOk("Created. Print it, stick it on the fridge, scan it on two phones.");
        } finally {
          $createBtn.disabled = false;
        }
      }

      async function copyUrl() {
        const url = $link.textContent;
        if (!url || url === "‚Äî") return;
        await navigator.clipboard.writeText(url);
        showOk("Copied URL to clipboard.");
      }

      function clearAll() {
        clearMsgs();
        $out.style.display = "none";
        $link.href = "#";
        $link.textContent = "‚Äî";
        $qrImg.removeAttribute("src");
        $printLabel.textContent = "";
      }

      $createBtn.addEventListener("click", () => createHousehold().catch(e => showErr(e.message || String(e))));
      $copyBtn.addEventListener("click", () => copyUrl().catch(e => showErr(e.message || String(e))));
      $printBtn.addEventListener("click", () => window.print());
      $clearBtn.addEventListener("click", clearAll);
    </script>
  </body>
</html>
