<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Fed Again ‚Äî Admin QR Generator</title>
    <style>
      :root { color-scheme: light; }
      body {
        margin: 0;
        font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
        background: #ffffff;
        color: #111;
      }
      .wrap {
        max-width: 900px;
        margin: 0 auto;
        padding: 28px 18px 40px;
      }

      h1 {
        font-size: 22px;
        margin: 0 0 14px;
        letter-spacing: -0.02em;
      }
      .sub {
        margin: 0 0 18px;
        color: #6b7280;
        font-size: 13px;
      }

      .grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 14px;
      }
      @media (min-width: 900px) {
        .grid { grid-template-columns: 1fr 1fr; }
      }

      .card {
        border: 1px solid #e5e7eb;
        border-radius: 14px;
        padding: 14px;
        background: #fff;
      }

      label {
        display: block;
        font-size: 12px;
        color: #6b7280;
        margin-bottom: 6px;
      }
      input {
        width: 100%;
        padding: 12px;
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        font-size: 14px;
        box-sizing: border-box;
        margin-bottom: 10px;
      }

      button {
        appearance: none;
        border: 1px solid #111;
        background: #fff;
        color: #111;
        border-radius: 12px;
        padding: 12px 12px;
        font-size: 14px;
        font-weight: 800;
        cursor: pointer;
      }
      button:disabled { opacity: 0.5; cursor: not-allowed; }

      .row2 {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
        margin-top: 6px;
      }
      .row3 {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        gap: 10px;
        margin-top: 6px;
      }

      .err {
        margin-top: 10px;
        color: #b91c1c;
        font-size: 13px;
        display: none;
        white-space: pre-wrap;
      }
      .ok {
        margin-top: 10px;
        color: #047857;
        font-size: 13px;
        display: none;
      }

      .out { display: none; margin-top: 12px; }
      a { word-break: break-all; }

      .listHead {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
        margin-bottom: 10px;
      }
      .small {
        font-size: 12px;
        color: #6b7280;
      }

      .tableWrap {
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        overflow: hidden;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 13px;
      }
      thead th {
        text-align: left;
        padding: 10px 12px;
        background: #f9fafb;
        border-bottom: 1px solid #e5e7eb;
        color: #374151;
        font-weight: 800;
      }
      tbody td {
        padding: 10px 12px;
        border-bottom: 1px solid #f1f5f9;
        vertical-align: top;
      }
      tbody tr:hover {
        background: #fafafa;
        cursor: pointer;
      }
      .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; font-size: 12px; }

      /* Preview */
      .previewTitle {
        font-size: 14px;
        font-weight: 900;
        margin: 0 0 10px;
      }
      .previewBox {
        border: 1px solid #e5e7eb;
        border-radius: 16px;
        padding: 14px;
        background: #fff;
        display: grid;
        place-items: center;
      }
      .previewBox img {
        width: 320px;
        max-width: 100%;
        border-radius: 10px;
        background: #fff;
      }

      /* Magnet Print Layout */
      .printArea {
        display: none;
      }

      .magnet {
        width: 90mm;
        height: 60mm;
        box-sizing: border-box;
        border: 1px solid #000;
        border-radius: 4mm;
        padding: 4mm;
        display: grid;
        grid-template-rows: auto 1fr auto;
        gap: 3mm;
        align-items: center;
        justify-items: center;
      }
      .magTitle {
        font-size: 14pt;
        font-weight: 900;
        text-align: center;
        letter-spacing: -0.02em;
        line-height: 1.1;
      }
      .magQR img {
        width: 40mm;
        height: 40mm;
      }
      .magBrand {
        font-size: 8pt;
        font-weight: 900;
        letter-spacing: 0.22em;
        color: #6b7280;
      }
      .magLabel {
        font-size: 9pt;
        font-weight: 900;
        margin-top: 1mm;
        text-align: center;
      }

      @media print {
        body { margin: 0; }
        .wrap { display: none !important; }
        .printArea { display: block; padding: 0; margin: 0; }
      }

      /* Ask browser to print close to magnet size (support varies by browser/printer) */
      @page {
        size: 90mm 60mm;
        margin: 0;
      }
    </style>
  </head>

  <body>
    <div class="wrap">
      <h1>Fed Again ‚Äî Admin QR Generator</h1>
      <p class="sub">Create, list, and reprint household QRs (includes both <code>h</code> and <code>k</code>).</p>

      <div class="grid">
        <!-- Create -->
        <div class="card">
          <label for="label">Household label</label>
          <input id="label" type="text" placeholder="e.g. Pawsha‚Äôs Fridge / Mum‚Äôs House / House 07" />

          <label for="secret">Admin secret</label>
          <input id="secret" type="password" placeholder="Enter admin secret" />

          <div class="row2">
            <button id="createBtn" type="button">Create household + QR</button>
            <button id="clearBtn" type="button">Clear</button>
          </div>

          <div class="row2" style="margin-top:10px;">
            <button id="loadBtn" type="button">Load existing households</button>
            <button id="hideBtn" type="button">Hide list</button>
          </div>

          <div class="err" id="err"></div>
          <div class="ok" id="ok"></div>
        </div>

        <!-- Preview -->
        <div class="card">
          <div class="previewTitle">Preview / Print (Fridge Magnet)</div>

          <div class="small" style="margin-bottom:8px;">
            Click a household in the list (or create a new one) to preview it here.
          </div>

          <div class="out" id="out">
            <label>Household URL</label>
            <a id="link" href="#" target="_blank" rel="noopener">‚Äî</a>

            <div class="row3" style="margin-top:10px;">
              <button id="copyBtn" type="button">Copy URL</button>
              <button id="printBtn" type="button">Print magnet</button>
              <button id="openBtn" type="button">Open</button>
            </div>

            <div class="previewBox" style="margin-top:12px;">
              <img id="qrImg" alt="QR code" />
            </div>

            <div class="magLabel" id="previewLabel" style="margin-top:10px;"></div>
          </div>

          <div class="small" id="noPreview">No QR selected yet.</div>
        </div>
      </div>

      <!-- List -->
      <div class="card" id="listCard" style="margin-top:14px; display:none;">
        <div class="listHead">
          <div>
            <div style="font-weight:900;">Existing households</div>
            <div class="small">Click a row to preview + print.</div>
          </div>
          <div class="small" id="count">0</div>
        </div>

        <div class="tableWrap">
          <table>
            <thead>
              <tr>
                <th style="width:38%;">Label</th>
                <th style="width:22%;">Created</th>
                <th style="width:40%;">ID</th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Hidden print-only magnet -->
    <div class="printArea">
      <div class="magnet">
        <div class="magTitle">Has üê∂ been Fed? Walked?</div>

        <div class="magQR">
          <img id="printQrImg" alt="QR code" />
        </div>

        <div>
          <div class="magLabel" id="printLabel"></div>
          <div class="magBrand">FED AGAIN</div>
        </div>
      </div>
    </div>

    <script>
      const $label = document.getElementById("label");
      const $secret = document.getElementById("secret");

      const $createBtn = document.getElementById("createBtn");
      const $clearBtn = document.getElementById("clearBtn");
      const $loadBtn = document.getElementById("loadBtn");
      const $hideBtn = document.getElementById("hideBtn");

      const $copyBtn = document.getElementById("copyBtn");
      const $printBtn = document.getElementById("printBtn");
      const $openBtn = document.getElementById("openBtn");

      const $err = document.getElementById("err");
      const $ok = document.getElementById("ok");

      const $out = document.getElementById("out");
      const $noPreview = document.getElementById("noPreview");

      const $link = document.getElementById("link");
      const $qrImg = document.getElementById("qrImg");
      const $previewLabel = document.getElementById("previewLabel");

      const $printQrImg = document.getElementById("printQrImg");
      const $printLabel = document.getElementById("printLabel");

      const $listCard = document.getElementById("listCard");
      const $tbody = document.getElementById("tbody");
      const $count = document.getElementById("count");

      let current = null;

      function showErr(msg) {
        $err.textContent = msg;
        $err.style.display = "block";
        $ok.style.display = "none";
      }
      function showOk(msg) {
        $ok.textContent = msg;
        $ok.style.display = "block";
        $err.style.display = "none";
      }
      function clearMsgs() {
        $err.textContent = "";
        $err.style.display = "none";
        $ok.textContent = "";
        $ok.style.display = "none";
      }

      function isoToNice(iso) {
        if (!iso) return "‚Äî";
        const d = new Date(iso);
        if (Number.isNaN(d.getTime())) return "‚Äî";
        return d.toLocaleString();
      }

      function setPreview(payload) {
        current = payload;

        $link.href = payload.url;
        $link.textContent = payload.url;

        $qrImg.src = payload.qrPngUrl;

        $previewLabel.textContent = payload.label || "";
        $printLabel.textContent = payload.label || "";
        $printQrImg.src = payload.qrPngUrl;

        $noPreview.style.display = "none";
        $out.style.display = "block";
      }

      async function createHousehold() {
        clearMsgs();
        $createBtn.disabled = true;

        try {
          const secret = $secret.value.trim();
          const label = $label.value.trim();

          if (!label) throw new Error("Enter a household label (so you don‚Äôt mix them up).");
          if (!secret) throw new Error("Enter the admin secret.");

          const resp = await fetch("/api/create-household", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "x-admin-secret": secret
            },
            body: JSON.stringify({ label })
          });

          const text = await resp.text();
          let json;
          try { json = JSON.parse(text); } catch { throw new Error(text); }
          if (!resp.ok) throw new Error(json?.error || "Request failed.");

          setPreview(json);
          showOk("Created. Click Print magnet to print the fridge label.");
          await loadHouseholds(); // refresh list
        } finally {
          $createBtn.disabled = false;
        }
      }

      async function loadHouseholds() {
        clearMsgs();

        const secret = $secret.value.trim();
        if (!secret) {
          showErr("Enter the admin secret first (needed to load the list).");
          return;
        }

        $loadBtn.disabled = true;
        try {
          const resp = await fetch("/api/list-households", {
            method: "GET",
            headers: {
              "x-admin-secret": secret
            }
          });

          const text = await resp.text();
          let json;
          try { json = JSON.parse(text); } catch { throw new Error(text); }
          if (!resp.ok) throw new Error(json?.error || "Request failed.");

          const rows = json.households || [];
          $tbody.innerHTML = "";
          $count.textContent = `${rows.length} total`;
          $listCard.style.display = "block";

          for (const row of rows) {
            const url = `${location.origin}/?h=${encodeURIComponent(row.id)}&k=${encodeURIComponent(row.edit_key)}`;
            const qrPngUrl = `https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${encodeURIComponent(url)}`;

            const tr = document.createElement("tr");
            tr.innerHTML = `
              <td>${escapeHtml(row.label || "")}</td>
              <td>${escapeHtml(isoToNice(row.created_at))}</td>
              <td class="mono">${escapeHtml(row.id)}</td>
            `;

            tr.addEventListener("click", () => {
              setPreview({
                householdId: row.id,
                label: row.label || "",
                url,
                qrPngUrl
              });
              showOk("Selected. Print magnet when ready.");
            });

            $tbody.appendChild(tr);
          }

          showOk("Loaded households.");
        } finally {
          $loadBtn.disabled = false;
        }
      }

      async function copyUrl() {
        if (!current?.url) return;
        await navigator.clipboard.writeText(current.url);
        showOk
