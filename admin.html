<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Fed Again ‚Äî Admin QR Generator</title>
    <style>
      :root { color-scheme: light; }
      body {
        margin: 0;
        font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
        background: #ffffff;
        color: #111;
      }
      .wrap {
        max-width: 780px;
        margin: 0 auto;
        padding: 28px 18px 60px;
      }
      h1 {
        font-size: 28px;
        font-weight: 800;
        margin: 0 0 8px;
        letter-spacing: -0.02em;
      }
      .sub {
        margin: 0 0 22px;
        color: #6b7280;
      }
      .card {
        border: 1px solid #e5e7eb;
        border-radius: 14px;
        padding: 16px;
        background: #fff;
        margin: 12px 0;
      }
      label {
        display: block;
        font-size: 13px;
        color: #374151;
        margin: 10px 0 6px;
        font-weight: 600;
      }
      input {
        width: 100%;
        box-sizing: border-box;
        border: 1px solid #d1d5db;
        border-radius: 12px;
        padding: 12px 12px;
        font-size: 16px;
        outline: none;
      }
      input:focus { border-color: #111; }
      .row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
        margin-top: 14px;
      }
      .row3 {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        gap: 12px;
        margin-top: 14px;
      }
      button {
        appearance: none;
        border: 1px solid #111;
        background: #fff;
        color: #111;
        border-radius: 12px;
        padding: 14px 12px;
        font-size: 16px;
        font-weight: 800;
        cursor: pointer;
      }
      button:active { transform: translateY(1px); }
      button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .ok {
        margin-top: 10px;
        color: #065f46;
        font-size: 14px;
        display: none;
        font-weight: 700;
      }
      .err {
        margin-top: 10px;
        color: #b91c1c;
        font-size: 14px;
        display: none;
        font-weight: 700;
        white-space: pre-wrap;
      }

      .result {
        display: none;
        margin-top: 14px;
      }
      .result a {
        word-break: break-all;
      }

      .qrWrap {
        display: grid;
        grid-template-columns: 1fr;
        gap: 14px;
        align-items: start;
      }
      .qrBox {
        border: 1px solid #e5e7eb;
        border-radius: 14px;
        padding: 14px;
      }
      .qrBox img {
        display: block;
        width: 280px;
        height: 280px;
        max-width: 100%;
        margin: 0 auto;
      }
      .tiny {
        font-size: 12px;
        color: #6b7280;
        margin-top: 8px;
        text-align: center;
      }

      /* ---------------- PRINT (FRIDGE MAGNET) ---------------- */
      @media print {
        body { background: #fff; }
        .wrap { padding: 0; max-width: none; }
        .noPrint { display: none !important; }
        .printOnly { display: block !important; }
      }

      .printOnly { display: none; }

      .magnetPage {
        width: 90mm;           /* fridge magnet-ish */
        height: 120mm;
        margin: 0 auto;
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        padding: 10mm 8mm;
        box-sizing: border-box;
        display: grid;
        grid-template-rows: auto 1fr auto auto;
        gap: 6mm;
      }
      .magTitle {
        text-align: center;
        font-weight: 900;
        font-size: 18pt;
        letter-spacing: -0.02em;
      }
      .magQR {
        display: grid;
        place-items: center;
      }
      .magQR img {
        width: 70mm;
        height: 70mm;
      }
      .magLabel {
        text-align: center;
        font-weight: 800;
        font-size: 12pt;
        color: #111;
      }
      .magBrand {
        text-align: center;
        letter-spacing: 0.22em;
        font-size: 10pt;
        color: #6b7280;
        font-weight: 900;
      }

      .mutedNote {
        font-size: 12px;
        color: #6b7280;
        margin-top: 6px;
      }
    </style>
  </head>

  <body>
    <div class="wrap">
      <div class="noPrint">
        <h1>Fed Again ‚Äî Admin QR Generator</h1>
        <p class="sub">Create a labelled household QR (includes both <b>h</b> and <b>k</b>) so updates are allowed.</p>

        <div class="card">
          <label for="label">Household label (prints under QR)</label>
          <input id="label" placeholder="e.g., Pawsha‚Äôs Fridge / Mum‚Äôs House / Unit 3" />

          <label for="secret">Admin secret (not stored)</label>
          <input id="secret" type="password" placeholder="ADMIN_SECRET" />

          <div class="row">
            <button id="createBtn">Create household + QR</button>
            <button id="clearBtn" type="button">Clear</button>
          </div>

          <div class="ok" id="ok"></div>
          <div class="err" id="err"></div>

          <div class="result" id="result">
            <div class="card">
              <div style="font-weight:800; margin-bottom:8px;">Household URL</div>
              <a id="urlLink" href="#" target="_blank" rel="noreferrer"></a>

              <div class="row3">
                <button id="copyBtn" type="button">Copy URL</button>
                <button id="openBtn" type="button">Open</button>
                <button id="printBtn" type="button">Print QR</button>
              </div>

              <div class="qrWrap" style="margin-top:14px;">
                <div class="qrBox">
                  <img id="qrImg" alt="QR code" />
                  <div class="tiny">Scan to link this device</div>
                  <div class="mutedNote">
                    Tip: Use a label you‚Äôll recognize later (e.g. ‚ÄúMum ‚Äî Kitchen Fridge‚Äù).
                  </div>
                </div>
              </div>

              <div class="mutedNote" style="margin-top:10px;">
                Want to re-print later? Keep your label consistent ‚Äî we‚Äôll add a ‚Äúlookup by label‚Äù next (2 mins).
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- PRINT LAYOUT -->
      <div class="printOnly">
        <div class="magnetPage">
          <div class="magTitle">Has üê∂ been Fed? Walked?</div>
          <div class="magQR">
            <img id="printQrImg" alt="QR code" />
          </div>
          <div class="magLabel" id="printLabel"></div>
          <div class="magBrand">FED AGAIN</div>
        </div>
      </div>
    </div>

    <script>
      const $label = document.getElementById("label");
      const $secret = document.getElementById("secret");

      const $createBtn = document.getElementById("createBtn");
      const $clearBtn = document.getElementById("clearBtn");

      const $copyBtn = document.getElementById("copyBtn");
      const $openBtn = document.getElementById("openBtn");
      const $printBtn = document.getElementById("printBtn");

      const $ok = document.getElementById("ok");
      const $err = document.getElementById("err");
      const $result = document.getElementById("result");

      const $urlLink = document.getElementById("urlLink");
      const $qrImg = document.getElementById("qrImg");

      const $printQrImg = document.getElementById("printQrImg");
      const $printLabel = document.getElementById("printLabel");

      let last = null;

      function showOk(msg) {
        $ok.textContent = msg;
        $ok.style.display = "block";
      }
      function clearOk() {
        $ok.textContent = "";
        $ok.style.display = "none";
      }
      function showErr(msg) {
        $err.textContent = msg;
        $err.style.display = "block";
      }
      function clearErr() {
        $err.textContent = "";
        $err.style.display = "none";
      }

      function resetUI() {
        clearOk();
        clearErr();
        $result.style.display = "none";
        last = null;
        $urlLink.textContent = "";
        $urlLink.href = "#";
        $qrImg.src = "";
        $printQrImg.src = "";
        $printLabel.textContent = "";
      }

      async function createHousehold() {
        clearOk();
        clearErr();

        const label = ($label.value || "").trim();
        const secret = ($secret.value || "").trim();

        if (!label) return showErr("Add a household label (so you don‚Äôt mix magnets up).");
        if (!secret) return showErr("Enter admin secret.");

        $createBtn.disabled = true;

        try {
          const resp = await fetch("/api/create-household", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "x-admin-secret": secret
            },
            body: JSON.stringify({ label })
          });

          const text = await resp.text();
          let json = null;
          try { json = JSON.parse(text); } catch (_) {}

          if (!resp.ok) {
            const msg = json?.error ? json.error : text;
            throw new Error(msg || "Request failed");
          }

          last = json;

          $urlLink.textContent = json.url;
          $urlLink.href = json.url;

          $qrImg.src = json.qrPngUrl;

          // print layout uses same QR image
          $printQrImg.src = json.qrPngUrl;
          $printLabel.textContent = label;

          $result.style.display = "block";
          showOk("Created. Print it, stick it on the fridge, scan it on two phones.");

        } catch (e) {
          showErr(e?.message || String(e));
        } finally {
          $createBtn.disabled = false;
        }
      }

      async function copyUrl() {
        clearErr();
        if (!last?.url) return;
        try {
          await navigator.clipboard.writeText(last.url);
          showOk("Copied URL.");
        } catch (e) {
          showErr("Could not copy (browser blocked clipboard).");
        }
      }

      function openUrl() {
        clearErr();
        if (!last?.url) return;
        window.open(last.url, "_blank", "noopener,noreferrer");
      }

      function printMagnet() {
        clearErr();
        if (!last?.qrPngUrl) return showErr("Create a QR first.");
        window.print();
      }

      $createBtn.addEventListener("click", () => createHousehold());
      $clearBtn.addEventListener("click", () => {
        $label.value = "";
        $secret.value = "";
        resetUI();
      });

      $copyBtn.addEventListener("click", () => copyUrl());
      $openBtn.addEventListener("click", () => openUrl());
      $printBtn.addEventListener("click", () => printMagnet());

      resetUI();
    </script>
  </body>
</html>
