<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Fed Again — Admin QR Generator</title>
    <style>
      :root { color-scheme: light; }
      body {
        margin: 0;
        font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
        background: #ffffff;
        color: #111;
      }
      .wrap {
        max-width: 640px;
        margin: 0 auto;
        padding: 28px 18px 40px;
      }
      h1 {
        font-size: 22px;
        margin: 0 0 14px;
        letter-spacing: -0.02em;
      }
      .sub {
        margin: 0 0 18px;
        color: #6b7280;
        font-size: 13px;
      }
      .card {
        border: 1px solid #e5e7eb;
        border-radius: 14px;
        padding: 14px;
        background: #fff;
        margin: 12px 0;
      }
      label {
        display: block;
        font-size: 12px;
        color: #6b7280;
        margin-bottom: 6px;
      }
      input {
        width: 100%;
        padding: 12px;
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        font-size: 14px;
        box-sizing: border-box;
      }
      button {
        appearance: none;
        border: 1px solid #111;
        background: #fff;
        color: #111;
        border-radius: 12px;
        padding: 12px 12px;
        font-size: 14px;
        font-weight: 800;
        cursor: pointer;
      }
      button:disabled { opacity: 0.5; cursor: not-allowed; }
      .row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
        margin-top: 10px;
      }
      .err {
        margin-top: 10px;
        color: #b91c1c;
        font-size: 13px;
        display: none;
      }
      .ok {
        margin-top: 10px;
        color: #047857;
        font-size: 13px;
        display: none;
      }
      .out {
        display: none;
      }
      a {
        word-break: break-all;
      }
      .qr {
        display: grid;
        place-items: center;
        padding: 10px;
      }
      img {
        width: 320px;
        max-width: 100%;
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        background: #fff;
        padding: 10px;
      }
      .hint {
        color: #6b7280;
        font-size: 12px;
        margin-top: 8px;
        text-align: center;
      }
      @media print {
        body { background: #fff; }
        .no-print { display: none !important; }
        .wrap { max-width: none; padding: 0; }
        .card { border: none; }
        img { border: none; }
      }
    </style>
  </head>

  <body>
    <div class="wrap">
      <div class="no-print">
        <h1>Fed Again — Admin QR Generator</h1>
        <p class="sub">Create a household link + QR (includes both <code>h</code> and <code>k</code>).</p>

        <div class="card">
          <label for="secret">Admin secret (not stored)</label>
          <input id="secret" type="password" placeholder="Enter x-admin-secret value" />

          <div class="row">
            <button id="createBtn">Create household + QR</button>
            <button id="clearBtn" type="button">Clear</button>
          </div>

          <div class="err" id="err"></div>
          <div class="ok" id="ok"></div>
        </div>
      </div>

      <div class="card out" id="out">
        <div class="no-print" style="margin-bottom:12px;">
          <label>Household URL</label>
          <a id="link" href="#" target="_blank" rel="noopener">—</a>

          <div class="row" style="margin-top:10px;">
            <button id="copyBtn" type="button">Copy URL</button>
            <button id="printBtn" type="button">Print QR</button>
          </div>
        </div>

        <div class="qr">
          <div>
            <img id="qrImg" alt="QR code" />
            <div class="hint">Scan to link this device</div>
          </div>
        </div>
      </div>
    </div>

    <script>
      const $secret = document.getElementById("secret");
      const $createBtn = document.getElementById("createBtn");
      const $clearBtn = document.getElementById("clearBtn");
      const $copyBtn = document.getElementById("copyBtn");
      const $printBtn = document.getElementById("printBtn");
      const $err = document.getElementById("err");
      const $ok = document.getElementById("ok");
      const $out = document.getElementById("out");
      const $link = document.getElementById("link");
      const $qrImg = document.getElementById("qrImg");

      function showErr(msg) {
        $err.textContent = msg;
        $err.style.display = "block";
        $ok.style.display = "none";
      }
      function showOk(msg) {
        $ok.textContent = msg;
        $ok.style.display = "block";
        $err.style.display = "none";
      }
      function clearMsgs() {
        $err.textContent = "";
        $err.style.display = "none";
        $ok.textContent = "";
        $ok.style.display = "none";
      }

      async function createHousehold() {
        clearMsgs();
        $createBtn.disabled = true;

        try {
          const secret = $secret.value.trim();
          if (!secret) throw new Error("Enter the admin secret.");

          const resp = await fetch("/api/create-household", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "x-admin-secret": secret
            },
            body: JSON.stringify({ name: "Fed Again Household" })
          });

          const text = await resp.text();
          let json;
          try { json = JSON.parse(text); } catch { throw new Error(text); }

          if (!resp.ok) throw new Error(json?.error || "Request failed.");

          $link.href = json.url;
          $link.textContent = json.url;
          $qrImg.src = json.qrPngUrl;

          $out.style.display = "block";
          showOk("Created. Print it, stick it on the fridge, scan it on two phones.");
        } finally {
          $createBtn.disabled = false;
        }
      }

      async function copyUrl() {
        const url = $link.textContent;
        if (!url || url === "—") return;
        await navigator.clipboard.writeText(url);
        showOk("Copied URL to clipboard.");
      }

      function clearAll() {
        clearMsgs();
        $out.style.display = "none";
        $link.href = "#";
        $link.textContent = "—";
        $qrImg.removeAttribute("src");
      }

      $createBtn.addEventListener("click", () => createHousehold().catch(e => showErr(e.message || String(e))));
      $copyBtn.addEventListener("click", () => copyUrl().catch(e => showErr(e.message || String(e))));
      $printBtn.addEventListener("click", () => window.print());
      $clearBtn.addEventListener("click", clearAll);
    </script>
  </body>
</html>
