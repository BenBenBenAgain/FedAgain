<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Fed Again ‚Äî Admin QR Generator</title>
    <style>
      :root { color-scheme: light; }
      body {
        margin: 0;
        font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
        background: #fff;
        color: #111;
      }
      .wrap {
        max-width: 980px;
        margin: 0 auto;
        padding: 28px 18px 60px;
      }
      h1 {
        margin: 0 0 8px;
        font-size: 34px;
        letter-spacing: -0.02em;
      }
      .sub {
        margin: 0 0 18px;
        color: #6b7280;
        font-size: 14px;
      }
      .card {
        border: 1px solid #e5e7eb;
        border-radius: 16px;
        padding: 16px;
        background: #fff;
        margin: 14px 0;
      }
      label {
        display: block;
        font-size: 13px;
        color: #6b7280;
        margin-bottom: 6px;
      }
      input {
        width: 100%;
        box-sizing: border-box;
        padding: 12px 12px;
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        font-size: 16px;
        outline: none;
      }
      input:focus { border-color: #111; }
      .row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
        margin-top: 12px;
      }
      button {
        appearance: none;
        border: 1px solid #111;
        background: #fff;
        color: #111;
        border-radius: 12px;
        padding: 12px 12px;
        font-size: 16px;
        font-weight: 700;
        cursor: pointer;
      }
      button:active { transform: translateY(1px); }
      button:disabled { opacity: 0.5; cursor: not-allowed; }
      .muted {
        color: #6b7280;
        font-size: 13px;
      }
      .ok {
        margin-top: 10px;
        color: #047857;
        font-size: 13px;
        display: none;
      }
      .err {
        margin-top: 10px;
        color: #b91c1c;
        font-size: 13px;
        display: none;
        white-space: pre-wrap;
      }

      .resultGrid {
        display: grid;
        grid-template-columns: 1.2fr 0.8fr;
        gap: 16px;
        align-items: start;
        margin-top: 12px;
      }
      .mono {
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
        font-size: 13px;
        white-space: pre-wrap;
        word-break: break-word;
      }
      .qrBox {
        border: 1px solid #e5e7eb;
        border-radius: 16px;
        padding: 12px;
        display: grid;
        place-items: center;
      }
      .qrBox img { width: 100%; max-width: 320px; height: auto; }

      .sectionTitle {
        display: flex;
        align-items: baseline;
        justify-content: space-between;
        gap: 12px;
      }
      .sectionTitle h2 {
        margin: 0;
        font-size: 20px;
        letter-spacing: -0.02em;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 10px;
      }
      th, td {
        text-align: left;
        border-bottom: 1px solid #e5e7eb;
        padding: 12px 10px;
        vertical-align: middle;
      }
      th {
        font-size: 12px;
        color: #6b7280;
        font-weight: 700;
        letter-spacing: 0.04em;
        text-transform: none;
      }
      td .pill {
        display: inline-block;
        padding: 6px 10px;
        border: 1px solid #e5e7eb;
        border-radius: 999px;
        font-size: 12px;
        color: #374151;
      }
      .actions {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        justify-content: flex-end;
      }
      .btnSmall {
        padding: 10px 12px;
        font-size: 14px;
        border-radius: 12px;
      }
      .rightBtns {
        display: flex;
        gap: 10px;
        align-items: center;
      }

      .brand {
        margin-top: 26px;
        text-align: center;
        letter-spacing: 0.22em;
        font-size: 11px;
        color: #9ca3af;
        font-weight: 700;
      }
    </style>
  </head>

  <body>
    <div class="wrap">
      <h1>Fed Again ‚Äî Admin QR Generator</h1>
      <p class="sub">Create a labelled household QR (includes both <b>h</b> and <b>k</b>) and re-print from the household list.</p>

      <div class="card">
        <label for="label">Household label (prints under QR)</label>
        <input id="label" placeholder="e.g. Pawsha's Fridge" />

        <div style="height:12px"></div>

        <label for="secret">Admin secret (not stored)</label>
        <input id="secret" type="password" placeholder="Enter admin secret" />

        <div class="row">
          <button id="createBtn">Create household + QR</button>
          <button id="clearBtn">Clear</button>
        </div>

        <div class="ok" id="ok"></div>
        <div class="err" id="err"></div>

        <div class="resultGrid" style="display:none" id="resultGrid">
          <div>
            <div class="muted" style="margin-bottom:6px">Household URL</div>
            <div class="mono" id="urlOut"></div>

            <div class="row" style="grid-template-columns: 1fr 1fr; margin-top:12px;">
              <button class="btnSmall" id="copyBtn">Copy URL</button>
              <button class="btnSmall" id="openBtn">Open</button>
            </div>

            <div class="row" style="grid-template-columns: 1fr 1fr; margin-top:12px;">
              <button class="btnSmall" id="printBtn">Print Magnet</button>
              <button class="btnSmall" id="refreshListBtn2">Refresh list</button>
            </div>
          </div>

          <div class="qrBox">
            <img id="qrImg" alt="QR code" />
          </div>
        </div>
      </div>

      <div class="card" id="listCard">
        <div class="sectionTitle">
          <div>
            <h2>Household list</h2>
            <div class="muted">Recent households from Supabase (label + created time). Use this to re-print.</div>
            <div class="muted" id="listMeta" style="margin-top:6px;">Not loaded.</div>
          </div>
          <div class="rightBtns">
            <button class="btnSmall" id="refreshListBtn">Refresh list</button>
            <button class="btnSmall" id="toggleListBtn">Show/Hide</button>
          </div>
        </div>

        <div id="listWrap" style="margin-top:10px;">
          <table>
            <thead>
              <tr>
                <th style="width: 26%;">Label</th>
                <th style="width: 22%;">Created</th>
                <th>Household</th>
                <th style="width: 22%; text-align:right;">Actions</th>
              </tr>
            </thead>
            <tbody id="listBody"></tbody>
          </table>
        </div>
      </div>

      <div class="brand">FED AGAIN</div>
    </div>

    <script>
      const $label = document.getElementById("label");
      const $secret = document.getElementById("secret");

      const $createBtn = document.getElementById("createBtn");
      const $clearBtn = document.getElementById("clearBtn");

      const $copyBtn = document.getElementById("copyBtn");
      const $openBtn = document.getElementById("openBtn");
      const $printBtn = document.getElementById("printBtn");

      const $ok = document.getElementById("ok");
      const $err = document.getElementById("err");

      const $resultGrid = document.getElementById("resultGrid");
      const $urlOut = document.getElementById("urlOut");
      const $qrImg = document.getElementById("qrImg");

      const $refreshListBtn = document.getElementById("refreshListBtn");
      const $refreshListBtn2 = document.getElementById("refreshListBtn2");
      const $toggleListBtn = document.getElementById("toggleListBtn");
      const $listWrap = document.getElementById("listWrap");
      const $listMeta = document.getElementById("listMeta");
      const $listBody = document.getElementById("listBody");

      let last = null;

      function showOk(msg) {
        $ok.textContent = msg;
        $ok.style.display = "block";
      }
      function clearOk() {
        $ok.textContent = "";
        $ok.style.display = "none";
      }
      function showErr(msg) {
        $err.textContent = msg;
        $err.style.display = "block";
      }
      function clearErr() {
        $err.textContent = "";
        $err.style.display = "none";
      }

      function openUrl(url = null) {
        clearErr();
        const u = url || last?.url;
        if (!u) return;
        window.open(u, "_blank", "noopener,noreferrer");
      }

      async function copyText(text) {
        await navigator.clipboard.writeText(text);
      }

      function printMagnet(qrUrl, label) {
        const qr = qrUrl || last?.qrPngUrl;
        const lab = (label || last?.label || $label.value || "").trim() || "HOUSEHOLD";
        if (!qr) return showErr("No QR to print.");

        const w = window.open("", "_blank", "noopener,noreferrer");
        const safeLabel = lab.replace(/[<>]/g, "");
        w.document.open();
        w.document.write(`<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Fed Again Magnet</title>
    <style>
      :root { color-scheme: light; }
      body {
        margin: 0;
        font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
        background: #ffffff;
        display: grid;
        place-items: center;
        min-height: 100vh;
      }

      /* Magnet size */
      .magnet {
        width: 90mm;
        height: 120mm;
        box-sizing: border-box;
        padding: 12mm 10mm 10mm;
        text-align: center;
        border-radius: 18px;
        border: 1.5px solid #e5e7eb;
        display: grid;
        grid-template-rows: auto 1fr auto auto;
        gap: 6mm;
      }

      .title {
        font-size: 22px;
        font-weight: 800;
        letter-spacing: -0.02em;
        line-height: 1.15;
      }

      .qr img {
        width: 62mm;
        height: 62mm;
      }

      .label {
        font-size: 14px;
        font-weight: 800;
        letter-spacing: 0.10em;
      }

      .brand {
        font-size: 11px;
        letter-spacing: 0.28em;
        font-weight: 800;
        color: #9ca3af;
      }

      @page { margin: 10mm; }
      @media print {
        body { min-height: auto; }
      }
    </style>
  </head>
  <body>
    <div class="magnet">
      <div class="title">Has üê∂ been Fed?<br/>Walked?</div>
      <div class="qr"><img src="${qr}" alt="QR code" /></div>
      <div class="label">${safeLabel.toUpperCase()}</div>
      <div class="brand">FED AGAIN</div>
    </div>
    <script>
      window.onload = function () { window.print(); };
    </script>
  </body>
</html>`);
        w.document.close();
      }

      async function createHousehold() {
        clearErr();
        clearOk();
        $createBtn.disabled = true;

        const label = ($label.value || "").trim();
        const secret = ($secret.value || "").trim();
        if (!secret) {
          $createBtn.disabled = false;
          return showErr("Enter admin secret.");
        }

        try {
          const resp = await fetch("/api/create-household", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "x-admin-secret": secret
            },
            body: JSON.stringify({ label })
          });

          const text = await resp.text();
          let json = null;
          try { json = JSON.parse(text); } catch (_) {}

          if (!resp.ok) {
            const msg = json?.error ? json.error : text;
            throw new Error(msg || "Request failed");
          }

          last = {
            householdId: json.householdId,
            url: json.url,
            qrPngUrl: json.qrPngUrl,
            label: label || json.label || ""
          };

          $resultGrid.style.display = "grid";
          $urlOut.textContent = last.url;
          $qrImg.src = last.qrPngUrl;

          showOk("Created. Print it, stick it on the fridge, scan it on two phones.");

          // refresh list so you can re-print later even if you close the page
          loadList().catch(e => showErr(e.message || String(e)));
        } catch (e) {
          showErr(e.message || String(e));
        } finally {
          $createBtn.disabled = false;
        }
      }

      function clearAll() {
        clearErr();
        clearOk();
        last = null;
        $label.value = "";
        $resultGrid.style.display = "none";
        $urlOut.textContent = "";
        $qrImg.removeAttribute("src");
      }

      function fmtLocal(iso) {
        if (!iso) return "‚Äî";
        const d = new Date(iso);
        if (Number.isNaN(d.getTime())) return "‚Äî";
        return d.toLocaleString();
      }

      async function loadList() {
        clearErr();
        clearOk();

        const secret = ($secret.value || "").trim();
        if (!secret) return showErr("Enter admin secret (needed to load the list).");

        $refreshListBtn.disabled = true;
        $refreshListBtn2.disabled = true;
        $listMeta.textContent = "Loading‚Ä¶";
        $listBody.innerHTML = "";

        try {
          const resp = await fetch("/api/list-households", {
            method: "GET",
            headers: { "x-admin-secret": secret }
          });

          const text = await resp.text();
          let json = null;
          try { json = JSON.parse(text); } catch (_) {}

          if (!resp.ok) {
            const msg = json?.error ? json.error : text;
            throw new Error(msg || "Request failed");
          }

          const rows = json?.rows || [];
          $listMeta.textContent = `Loaded ${rows.length} households.`;

          for (const r of rows) {
            const tr = document.createElement("tr");

            const tdLabel = document.createElement("td");
            tdLabel.textContent = r.label || "(no label)";

            const tdCreated = document.createElement("td");
            const pill = document.createElement("span");
            pill.className = "pill";
            pill.textContent = fmtLocal(r.created_at);
            tdCreated.appendChild(pill);

            const tdId = document.createElement("td");
            tdId.className = "mono";
            tdId.textContent = r.id;

            const tdActions = document.createElement("td");
            tdActions.style.textAlign = "right";
            const actions = document.createElement("div");
            actions.className = "actions";

            const btnOpen = document.createElement("button");
            btnOpen.className = "btnSmall";
            btnOpen.textContent = "Open";
            btnOpen.onclick = () => openUrl(r.url);

            const btnPrint = document.createElement("button");
            btnPrint.className = "btnSmall";
            btnPrint.textContent = "Print";
            btnPrint.onclick = () => printMagnet(r.qrPngUrl, r.label || "");

            actions.appendChild(btnOpen);
            actions.appendChild(btnPrint);
            tdActions.appendChild(actions);

            tr.appendChild(tdLabel);
            tr.appendChild(tdCreated);
            tr.appendChild(tdId);
            tr.appendChild(tdActions);

            $listBody.appendChild(tr);
          }
        } finally {
          $refreshListBtn.disabled = false;
          $refreshListBtn2.disabled = false;
        }
      }

      // UI events
      $createBtn.addEventListener("click", () => createHousehold());
      $clearBtn.addEventListener("click", () => clearAll());

      $copyBtn.addEventListener("click", async () => {
        try {
          const u = last?.url;
          if (!u) return;
          await copyText(u);
          showOk("Copied URL.");
        } catch (e) {
          showErr(e.message || String(e));
        }
      });

      $openBtn.addEventListener("click", () => openUrl());
      $printBtn.addEventListener("click", () => printMagnet());

      $refreshListBtn.addEventListener("click", () => loadList().catch(e => showErr(e.message || String(e))));
      $refreshListBtn2.addEventListener("click", () => loadList().catch(e => showErr(e.message || String(e))));

      $toggleListBtn.addEventListener("click", () => {
        const isHidden = $listWrap.style.display === "none";
        $listWrap.style.display = isHidden ? "block" : "none";
      });
    </script>
  </body>
</html>
